<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Food Delivery — Patterns Demo (Observer / Strategy / Command)</title>
  <style>
    /* Simple, modern UI */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap');
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#ff6b6b;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:'Poppins',system-ui,Segoe UI,Arial}
    body{margin:0;background:linear-gradient(180deg,#061025 0%, #071826 100%);color:#e6eef8;min-height:100vh;padding:28px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:20px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    h2{margin:0 0 12px 0;font-size:18px}
    .restaurant{padding:10px;border-radius:8px;background:var(--glass);margin-bottom:10px;cursor:pointer}
    .restaurant:hover{transform:translateY(-2px)}
    .menu{margin-top:10px}
    .menu-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    button{border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn-primary{background:var(--accent);color:white}
    .controls{display:flex;gap:8px;align-items:center}
    .orders{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .order{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    .agent-log{height:120px;overflow:auto;padding:8px;background:#061427;border-radius:8px;font-size:13px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select,input[type=number]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px}
    footer{grid-column:1/-1;margin-top:16px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="left">
      <h2>Restaurants (Observable Subjects)</h2>
      <div id="restaurants"></div>
      <div style="margin-top:12px">
        <label class="small">Delivery Fee Strategy</label>
        <div class="row" style="margin-top:8px">
          <select id="strategySelect">
            <option value="standard">Standard Delivery (flat)</option>
            <option value="express">Express Delivery (base + per-km)</option>
            <option value="coupon">Free with Coupon</option>
          </select>
          <input id="distance" type="number" placeholder="distance km" value="3" style="width:120px">
        </div>
        <p class="small muted" style="margin-top:8px">Choose strategy to compute delivery fee when placing an order.</p>
      </div>
    </div>

    <div class="card" id="right">
      <h2>Order Builder & Command Panel</h2>
      <div class="flex" style="justify-content:space-between">
        <div>
          <div class="small muted">Selected Restaurant:</div>
          <div id="selectedRestaurant" class="small">— none —</div>
        </div>
        <div class="controls">
          <button id="placeOrderBtn" class="btn-primary">Place Order</button>
          <button id="cancelOrderBtn">Cancel Selected</button>
        </div>
      </div>

      <div class="menu" id="menu"></div>

      <h2 style="margin-top:16px">Active Orders</h2>
      <div class="orders" id="ordersList"></div>

      <h2 style="margin-top:12px">Delivery Agents (Observers)</h2>
      <div class="flex" style="justify-content:space-between;margin-bottom:8px">
        <div class="small muted">Agent Notifications</div>
        <div class="small muted">Command Queue: <span id="queueCount">0</span></div>
      </div>
      <div class="agent-log" id="agentLog"></div>
    </div>

    <footer class="card">
      Demo: Uses Observer (restaurant -> agents), Strategy (fee calculation), Command (place/cancel/track). Built with simple OO ES6 classes.
    </footer>
  </div>

  <script>
    /*****************************************************************
     * Domain models + Behavioral Patterns implemented with ES6 classes
     *****************************************************************/

    // ---------- Observer Pattern ----------
    // Subject: Restaurant
    class Restaurant {
      constructor(id, name, menu){
        this.id = id; this.name = name; this.menu = menu; this._observers = new Set();
      }
      subscribe(agent){ this._observers.add(agent); }
      unsubscribe(agent){ this._observers.delete(agent); }
      notify(order){ // called when a new order is placed
        this._observers.forEach(agent => agent.update(this, order));
      }
    }

    // Observer: DeliveryAgent
    class DeliveryAgent {
      constructor(id, name){ this.id = id; this.name = name; }
      update(restaurant, order){
        const message = `[Agent:${this.name}] New order #${order.id} at ${restaurant.name} — ${order.summary()}`;
        UI.logAgent(message);
      }
    }

    // ---------- Strategy Pattern ----------
    // Strategy interface: computeFee(order, distance)
    class StandardDeliveryStrategy {
      compute(order, distance){
        // flat 40
        return 40;
      }
    }
    class ExpressDeliveryStrategy {
      compute(order, distance){
        // base 30 + 10 per km
        return 30 + (10 * Math.max(0, distance));
      }
    }
    class CouponFreeStrategy {
      compute(order, distance){
        return 0; // free
      }
    }

    // ---------- Command Pattern ----------
    class CommandManager {
      constructor(){ this.queue = []; }
      execute(cmd){ this.queue.push(cmd); cmd.execute(); UI.updateQueue(this.queue.length); }
      undoLast(){ const cmd = this.queue.pop(); if(cmd && cmd.undo) cmd.undo(); UI.updateQueue(this.queue.length); }
    }

    class PlaceOrderCommand {
      constructor(system, order){ this.system = system; this.order = order; this.id = `cmd-place-${order.id}` }
      execute(){ this.system.placeOrder(this.order); }
      undo(){ this.system.cancelOrder(this.order.id); }
    }

    class CancelOrderCommand {
      constructor(system, orderId){ this.system = system; this.orderId = orderId; this.id = `cmd-cancel-${orderId}` }
      execute(){ this.system.cancelOrder(this.orderId); }
    }

    // ---------- Core System (uses OO principles: single responsibility, encapsulation) ----------
    class FoodDeliverySystem {
      constructor(){
        this.restaurants = new Map();
        this.agents = new Map();
        this.orders = new Map();
        this._nextOrderId = 1001;
        this.strategy = new StandardDeliveryStrategy();
      }
      addRestaurant(r){ this.restaurants.set(r.id, r); }
      addAgent(a){ this.agents.set(a.id, a); }
      subscribeAgentToRestaurant(agentId, restaurantId){
        const a = this.agents.get(agentId); const r = this.restaurants.get(restaurantId);
        if(a && r) r.subscribe(a);
      }
      setStrategy(strategy){ this.strategy = strategy; }

      createOrder(payload){
        const id = this._nextOrderId++;
        const order = new Order(id, payload.restaurantId, payload.items, payload.distance, payload.fee);
        return order;
      }

      placeOrder(order){
        this.orders.set(order.id, order);
        // notify restaurant observers (agents)
        const r = this.restaurants.get(order.restaurantId);
        if(r) r.notify(order);
        UI.addOrderCard(order);
      }

      cancelOrder(orderId){
        const o = this.orders.get(orderId);
        if(!o) return UI.info(`Order ${orderId} not found or already cancelled`);
        o.status = 'cancelled';
        UI.markOrderCancelled(orderId);
        this.orders.delete(orderId);
        UI.logAgent(`[System] Order ${orderId} cancelled.`);
      }

      trackOrder(orderId){
        const o = this.orders.get(orderId);
        if(!o) return UI.info(`Order ${orderId} not found`);
        return o.status;
      }
    }

    // Order entity
    class Order {
      constructor(id, restaurantId, items, distance, fee){
        this.id = id; this.restaurantId = restaurantId; this.items = items; this.distance = distance; this.fee = fee; this.status = 'placed';
      }
      total(){ return this.items.reduce((s,i)=>s+i.price,0) + this.fee; }
      summary(){ return `${this.items.map(i=>i.name).join(', ')} | Delivery: ₹${this.fee}`; }
    }

    /*****************************************************************
     * UI glue code — small adapter layer to connect patterns to a demo view
     *****************************************************************/
    const system = new FoodDeliverySystem();
    const cmdManager = new CommandManager();

    // create demo restaurants and agents
    const r1 = new Restaurant('r1','Pasta Planet', [ {name:'Margherita', price:149}, {name:'Alfredo', price:199} ]);
    const r2 = new Restaurant('r2','Curry Corner', [ {name:'Butter Chicken', price:189}, {name:'Paneer Tikka', price:159} ]);
    system.addRestaurant(r1); system.addRestaurant(r2);

    const a1 = new DeliveryAgent('a1','Ravi'); const a2 = new DeliveryAgent('a2','Priya');
    system.addAgent(a1); system.addAgent(a2);
    // subscribe both agents to both restaurants
    [r1.id,r2.id].forEach(rid=>{ system.subscribeAgentToRestaurant(a1.id,rid); system.subscribeAgentToRestaurant(a2.id,rid); });

    // UI namespace
    const UI = {
      restaurantsRoot: document.getElementById('restaurants'),
      menuRoot: document.getElementById('menu'),
      selectedRestaurantLabel: document.getElementById('selectedRestaurant'),
      ordersRoot: document.getElementById('ordersList'),
      agentLog: document.getElementById('agentLog'),
      queueCount: document.getElementById('queueCount'),
      selectedRestaurant: null,
      cart: [],

      init(){
        this.renderRestaurants();
        document.getElementById('strategySelect').addEventListener('change', () => this.updateStrategy());
        document.getElementById('placeOrderBtn').addEventListener('click', () => this.handlePlaceOrder());
        document.getElementById('cancelOrderBtn').addEventListener('click', () => this.handleCancelSelected());
        this.updateStrategy();
      },

      renderRestaurants(){
        this.restaurantsRoot.innerHTML = '';
        for(const r of system.restaurants.values()){
          const div = document.createElement('div'); div.className='restaurant'; div.innerHTML = `<strong>${r.name}</strong><div class='small muted'>${r.menu.length} items</div>`;
          div.addEventListener('click', ()=> this.selectRestaurant(r));
          this.restaurantsRoot.appendChild(div);
        }
      },

      selectRestaurant(r){
        this.selectedRestaurant = r; this.cart = [];
        this.selectedRestaurantLabel.textContent = r.name;
        this.menuRoot.innerHTML = '';
        r.menu.forEach((it, idx)=>{
          const mi = document.createElement('div'); mi.className='menu-item';
          mi.innerHTML = `<div><strong>${it.name}</strong><div class='small muted'>₹${it.price}</div></div>`;
          const addBtn = document.createElement('button'); addBtn.textContent='Add'; addBtn.addEventListener('click', ()=>{ this.cart.push(it); this.renderCartPreview(); });
          mi.appendChild(addBtn);
          this.menuRoot.appendChild(mi);
        });
        this.renderCartPreview();
      },

      renderCartPreview(){
        // show cart summary
        const prev = document.getElementById('cartPreview');
        if(prev) prev.remove();
        const box = document.createElement('div'); box.id='cartPreview'; box.style.marginTop='12px';
        box.innerHTML = `<div class='small muted'>Cart: ${this.cart.length} item(s)</div>` +
                        `<div class='small muted'>Items: ${this.cart.map(x=>x.name).join(', ')}</div>`;
        this.menuRoot.appendChild(box);
      },

      updateStrategy(){
        const sel = document.getElementById('strategySelect').value;
        const dist = Number(document.getElementById('distance').value) || 0;
        if(sel==='standard') system.setStrategy(new StandardDeliveryStrategy());
        else if(sel==='express') system.setStrategy(new ExpressDeliveryStrategy());
        else system.setStrategy(new CouponFreeStrategy());
        // store distance for computing fees when placing order
        this.distance = dist;
      },

      handlePlaceOrder(){
        if(!this.selectedRestaurant) return this.info('Pick a restaurant first');
        if(this.cart.length===0) return this.info('Add at least one item');
        // compute fee using strategy
        const fee = system.strategy.compute({items:this.cart}, this.distance || 0);
        const order = system.createOrder({ restaurantId:this.selectedRestaurant.id, items:this.cart.slice(), distance:this.distance, fee });
        const cmd = new PlaceOrderCommand(system, order);
        cmdManager.execute(cmd);
        // reset cart
        this.cart = [];
        this.renderCartPreview();
      },

      handleCancelSelected(){
        // simple demo: cancel the last order card selected in UI (we let user click to select an order)
        const selected = document.querySelector('.order.selected');
        if(!selected) return this.info('Click an order to select it, then cancel');
        const orderId = Number(selected.dataset.id);
        const cmd = new CancelOrderCommand(system, orderId);
        cmdManager.execute(cmd);
      },

      addOrderCard(order){
        const c = document.createElement('div'); c.className='order'; c.dataset.id = order.id; c.innerHTML = `<div><strong>Order #${order.id}</strong></div><div class='small muted'>${system.restaurants.get(order.restaurantId).name}</div><div class='small' style='margin-top:8px'>${order.items.map(i=>i.name).join(', ')}</div><div class='small muted' style='margin-top:6px'>Delivery: ₹${order.fee} • Total: ₹${order.total()}</div><div style='margin-top:8px' class='row'><button class='btn-primary track'>Track</button><button class='cancel small muted'>Cancel</button></div>`;
        // clicking selects
        c.addEventListener('click', (e)=>{ document.querySelectorAll('.order').forEach(x=>x.classList.remove('selected')); c.classList.add('selected'); });
        // track button
        c.querySelector('.track').addEventListener('click',(ev)=>{ ev.stopPropagation(); const status = system.trackOrder(order.id); this.info(`Order ${order.id} status: ${status}`); });
        // cancel button triggers cancel command
        c.querySelector('.cancel').addEventListener('click',(ev)=>{ ev.stopPropagation(); const cmd = new CancelOrderCommand(system, order.id); cmdManager.execute(cmd); });
        this.ordersRoot.prepend(c);
      },

      markOrderCancelled(orderId){
        const card = document.querySelector(`.order[data-id='${orderId}']`);
        if(card){ card.style.opacity = 0.5; card.querySelector('.cancel').textContent='Cancelled'; }
      },

      logAgent(text){
        const el = this.agentLog; const time = new Date().toLocaleTimeString(); el.innerHTML = `<div>[${time}] ${text}</div>` + el.innerHTML;
      },

      updateQueue(n){ this.queueCount.textContent = n; },

      info(msg){ alert(msg); }
    };

    // initialize UI
    UI.init();

    // expose some helpers to window for debugging
    window._system = system; window._ui = UI; window._cmd = cmdManager;

    // small usage hint logging
    UI.logAgent('[System] Demo ready. Click a restaurant, add items, choose strategy, then Place Order.');

  </script>
</body>
</html>
